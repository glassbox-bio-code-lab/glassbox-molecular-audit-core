{{- if .Values.job.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "molecular-audit-core.fullname" . }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    {{- include "molecular-audit-core.labels" . | nindent 4 }}
spec:
  backoffLimit: {{ .Values.job.backoffLimit }}
  ttlSecondsAfterFinished: {{ .Values.job.ttlSecondsAfterFinished }}
  activeDeadlineSeconds: {{ .Values.job.activeDeadlineSeconds }}
  template:
    metadata:
      labels:
        {{- include "molecular-audit-core.labels" . | nindent 8 }}
      {{- if eq .Values.storage.type "gcs" }}
      annotations:
        gke-gcsfuse/volumes: "true"
      {{- end }}
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "molecular-audit-core.serviceAccountName" . | quote }}
      initContainers:
        - name: init-volume-perms
          {{- if .Values.image.digest }}
          image: "{{ .Values.image.repository }}@{{ .Values.image.digest }}"
          {{- else }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          {{- end }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          securityContext:
            runAsUser: 0
          env:
            - name: MOUNT_PATH
              value: {{ if eq .Values.storage.type "gcs" }}{{ .Values.storage.gcs.mountPath | quote }}{{ else }}"/data"{{ end }}
          command:
            - bash
            - -lc
          args:
            - |
              set -euo pipefail
              # Ensure the PVC-backed /data paths are writable even when the main image runs as a non-root UID.
              mkdir -p "${MOUNT_PATH}/input" "${MOUNT_PATH}/output"
              chmod -R a+rwX "${MOUNT_PATH}/input" "${MOUNT_PATH}/output" || true
          volumeMounts:
            - name: mol-audit-data
              mountPath: {{ if eq .Values.storage.type "gcs" }}{{ .Values.storage.gcs.mountPath }}{{ else }}/data{{ end }}
      containers:
        - name: molecular-audit-core
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          envFrom:
            - configMapRef:
                name: {{ include "molecular-audit-core.fullname" . }}-config
          env:
            - name: GBX_CONTAINER_IMAGE
              value: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
            {{- if .Values.image.digest }}
            - name: GBX_CONTAINER_IMAGE_DIGEST
              value: "{{ .Values.image.digest }}"
            {{- end }}
            {{ if .Values.marketplace.reportingSecret }}
            - name: UBB_REPORTING_ENABLED
              value: {{ ternary "true" "false" .Values.ubbagent.enabled | quote }}
            - name: UBB_AGENT_HOST
              value: "127.0.0.1"
            - name: UBB_AGENT_PORT
              value: {{ .Values.ubbagent.localPort | quote }}
            - name: UBB_METRIC_NAME
              value: {{ .Values.ubbagent.metricName | quote }}
            - name: MARKETPLACE_REPORTING_SECRET
              value: {{ .Values.marketplace.reportingSecret | quote }}
            - name: MARKETPLACE_ENTITLEMENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.marketplace.reportingSecret | quote }}
                  key: entitlement-id
            - name: MARKETPLACE_CONSUMER_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.marketplace.reportingSecret | quote }}
                  key: consumer-id
            {{ end }}
          command:
            - bash
            - -lc
          args:
            - |
              set -euo pipefail
              echo "[molecular-audit-core] project=${PROJECT_ID} phase=${PHASE}"
              if [[ "${UBB_REPORTING_ENABLED:-false}" == "true" ]]; then
                /opt/conda/bin/python -c $'import json,os,socket,time,urllib.request\nmetric=os.environ.get("UBB_METRIC_NAME","glassbox_mol_audit_run")\nhost=os.environ.get("UBB_AGENT_HOST","127.0.0.1")\nport=int(os.environ.get("UBB_AGENT_PORT","4567"))\ndeadline=time.time()+30\n\nwhile True:\n    try:\n        with socket.create_connection((host,port),timeout=2):\n            break\n    except Exception:\n        if time.time()>deadline:\n            raise SystemExit("ubbagent not ready")\n        time.sleep(1)\n\nstamp=time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime())\npayload={"name":metric,"startTime":stamp,"endTime":stamp,"value":{"int64Value":1}}\nbody=json.dumps(payload).encode("utf-8")\nurl=f"http://{host}:{port}/report"\nreq=urllib.request.Request(url,data=body,headers={"Content-Type":"application/json"})\nwith urllib.request.urlopen(req,timeout=10) as resp:\n    if 200 <= resp.status < 300:\n        print("[molecular-audit-core] usage reported")\n    else:\n        raise SystemExit(f"usage reporting failed: status {resp.status}")'
              fi
              /opt/conda/bin/python -m app.cvp_core_runner \
                --project-id "${PROJECT_ID}" \
                --input-root "${INPUT_PATH}" \
                --output-dir "${OUTPUT_PATH}"
          volumeMounts:
            - name: mol-audit-data
              mountPath: {{ if eq .Values.storage.type "gcs" }}{{ .Values.storage.gcs.mountPath }}{{ else }}/data{{ end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      {{- if and .Values.ubbagent.enabled .Values.marketplace.reportingSecret }}
        - name: ubbagent
          image: "{{ .Values.ubbagent.image.repository }}:{{ .Values.ubbagent.image.tag }}"
          imagePullPolicy: {{ .Values.ubbagent.image.pullPolicy }}
          env:
            - name: MARKETPLACE_CONSUMER_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.marketplace.reportingSecret | quote }}
                  key: consumer-id
          command:
            - /bin/sh
            - -c
          args:
            - |
              set -euo pipefail
              export MARKETPLACE_REPORTING_KEY_B64="$(base64 /var/marketplace/reporting-key | tr -d '\n')"
              envsubst < /etc/ubbagent/config.yaml > /tmp/ubbagent-config.yaml
              exec ubbagent --config /tmp/ubbagent-config.yaml --state-dir /var/ubbagent/state --local-port {{ .Values.ubbagent.localPort | quote }} -logtostderr -v 2
          volumeMounts:
            - name: ubbagent-config
              mountPath: /etc/ubbagent/config.yaml
              subPath: config.yaml
            - name: ubbagent-state
              mountPath: /var/ubbagent/state
            - name: marketplace-reporting
              mountPath: /var/marketplace
              readOnly: true
      {{- end }}
      volumes:
        - name: mol-audit-data
          {{- if eq .Values.storage.type "pvc" }}
          persistentVolumeClaim:
            claimName: {{ include "molecular-audit-core.fullname" . }}-data
          {{- else if eq .Values.storage.type "gcs" }}
          csi:
            driver: gcsfuse.csi.storage.gke.io
            volumeAttributes:
              bucketName: {{ .Values.storage.gcs.bucket | quote }}
              implicitDirs: "true"
              "implicit-dirs": "true"
              mountOptions: "implicit-dirs"
              gcsfuseOptions: "implicit-dirs"
          {{- end }}
        {{- if and .Values.ubbagent.enabled .Values.marketplace.reportingSecret }}
        - name: ubbagent-config
          configMap:
            name: {{ include "molecular-audit-core.fullname" . }}-ubbagent
        - name: ubbagent-state
          emptyDir: {}
        - name: marketplace-reporting
          secret:
            secretName: {{ .Values.marketplace.reportingSecret | quote }}
        {{- end }}
      nodeSelector:
        {{- toYaml .Values.nodeSelector | nindent 8 }}
      tolerations:
        {{- toYaml .Values.tolerations | nindent 8 }}
      affinity:
        {{- toYaml .Values.affinity | nindent 8 }}
{{- end }}
